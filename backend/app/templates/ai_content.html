<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Money Bots Â· AI Content Lab</title>
  <style>
    body{font-family:system-ui;background:#0b0f14;color:#e8edf5;margin:0}
    .wrap{padding:18px;max-width:1160px;margin:0 auto}
    h1,h2,h3{margin:0 0 12px}
    .muted{color:#94a3b8;font-size:0.92rem}
    .grid{display:grid;gap:16px;margin-top:18px}
    .two{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .panel{background:#111923;border-radius:14px;padding:18px;box-shadow:0 0 0 1px #1e2633}
    label{display:block;font-size:0.85rem;margin-top:8px;margin-bottom:4px;color:#9fb3d3}
    input,textarea,select{width:100%;background:#0e141d;color:#f1f5f9;border:1px solid #1f2937;border-radius:10px;padding:9px;font-size:0.95rem}
    textarea{min-height:96px;resize:vertical}
    button{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:9px 16px;margin-top:12px;font-size:0.95rem;cursor:pointer;transition:background .2s}
    button:hover{background:#1d4ed8}
    button.secondary{background:#1f2937}
    button.secondary:hover{background:#111827}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .chip{background:#1e293b;padding:4px 8px;border-radius:999px;font-size:0.8rem}
    .profile-card{padding:14px;background:#0f172a;border-radius:12px;border:1px solid #1f2a3a;margin-top:12px}
    .profile-card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .publisher-card{padding:14px;background:#0f172a;border-radius:12px;border:1px solid #1f2a3a;margin-top:12px}
    .publisher-card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .status{display:inline-flex;align-items:center;gap:6px;font-size:0.85rem}
    .status.ready{color:#4ade80}
    .status.needs_config{color:#facc15}
    .status.error{color:#f87171}
    .status.muted{color:#94a3b8}
    .job{background:#0f172a;border-radius:12px;border:1px solid #1f2a3a;padding:14px;margin-top:12px}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0b1220;border-radius:12px;padding:12px;margin-top:12px;font-size:0.9rem}
    .list-header{display:flex;justify-content:space-between;align-items:center}
    .small{font-size:0.8rem;color:#94a3b8}
    .actions button{margin-right:8px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .schedule-grid{display:grid;gap:16px;margin-top:12px}
    .schedule-platform{background:#0f172a;border:1px solid #1f2a3a;border-radius:12px;padding:14px}
    .schedule-platform header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .schedule-statuses{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .schedule-status-group{background:#0b1220;border-radius:12px;padding:12px;border:1px solid #1f2a3a}
    .schedule-status-title{font-size:0.8rem;text-transform:uppercase;color:#94a3b8;margin-bottom:8px}
    .schedule-entry{background:#0f172a;border-radius:10px;padding:10px;margin-bottom:8px;border:1px solid #1f2a3a}
    .schedule-entry strong{display:block;margin-bottom:4px}
    .schedule-entry .actions{margin-top:8px}
    .schedule-entry .actions button{margin-right:6px;margin-top:0}
    .status.badge{padding:2px 8px;border-radius:999px;font-size:0.75rem;background:#1e293b}
    .status.scheduled{color:#60a5fa}
    .status.posted{color:#4ade80}
    .status.failed{color:#f87171}
    .status.canceled{color:#94a3b8}
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,0.75);display:none;z-index:40}
    .modal-backdrop.active{display:block}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50;padding:20px}
    .modal.active{display:flex}
    .modal .modal-content{background:#111923;border-radius:14px;padding:20px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(8,15,25,0.6)}
    .modal .modal-content h3{margin-bottom:12px}
    .hidden{display:none}
    .schedule-board-header{display:flex;justify-content:space-between;align-items:center}
    .schedule-board-actions button{margin-top:0;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Money Making Bots</h1>
    <p class="muted">Build reusable voices and spin up social content, Reddit-style stories, or short-form video scripts on demand. Profiles capture tone, voice, and platform targets so every drop stays on-brand.</p>
    <div style="background:#1e293b;border-radius:14px;padding:16px;margin-bottom:18px;border:2px solid #2563eb">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong style="font-size:1.1rem">ðŸŽ¬ New Video Studio Available!</strong>
          <p class="muted" style="margin-top:6px">Try our redesigned video creation interface with better workflow and real-time preview</p>
        </div>
        <a href="/ui/video-studio" style="background:#2563eb;color:#fff;padding:10px 20px;border-radius:10px;text-decoration:none;font-weight:600">Launch Studio â†’</a>
      </div>
    </div>

    <section class="panel">
      <h3>0 Â· Platform connectors</h3>
      <p class="muted">Load API keys in <code>.env.production</code> and run health checks before flipping on automation.</p>
      <div id="publishersEmpty" class="muted" style="margin-top:12px;display:none">No publisher connectors detected.</div>
      <div id="publishersList"></div>
    </section>

    <div class="grid two">
      <section class="panel">
        <h3>1 Â· Save a creator profile</h3>
        <form id="profileForm">
          <label for="profile_name">Profile name</label>
          <input id="profile_name" placeholder="e.g. TikTok Storyteller" required>

          <label for="profile_tone">Tone / energy</label>
          <input id="profile_tone" placeholder="upbeat, witty, cinematic">

          <label for="profile_voice">Voice description</label>
          <input id="profile_voice" placeholder="first-person gamer, mentor, narrator">

          <label for="profile_platform">Primary platforms</label>
          <input id="profile_platform" placeholder="TikTok Â· Instagram Reels Â· Reddit">

          <label for="profile_rules">Guidelines / mandatory beats</label>
          <textarea id="profile_rules" placeholder="Key selling points, compliance notes, structure cues"></textarea>

          <button type="submit">Save profile</button>
        </form>
        <div id="profilesEmpty" class="muted" style="margin-top:12px;display:none">No profiles yet. Start by saving one.</div>
        <div id="profilesList"></div>
      </section>

      <section class="panel">
        <h3>2 Â· Generate content</h3>
        <form id="generationForm">
          <label for="gen_profile">Profile</label>
          <select id="gen_profile"></select>

          <label for="gen_type">Content type</label>
          <select id="gen_type">
            <option value="social-post">Social media drop (3 posts)</option>
            <option value="reddit-story">Reddit farm story</option>
            <option value="video-script">Short-form video script</option>
          </select>

          <label for="gen_title">Campaign title / hook</label>
          <input id="gen_title" placeholder="Farmed horror win in Apex Legends" required>

          <label for="gen_keywords">Keywords (comma separated)</label>
          <input id="gen_keywords" placeholder="gaming, apex legends, horror twist">

          <label for="gen_brief">Creative brief</label>
          <textarea id="gen_brief" placeholder="What should this piece accomplish?"></textarea>

          <label for="gen_sources">Data feeds / references</label>
          <textarea id="gen_sources" placeholder="Links, stats, existing docs"></textarea>

          <label for="gen_extra">Extra operator notes</label>
          <textarea id="gen_extra" placeholder="Add twists, monetization angles, CTA specifics"></textarea>

          <div class="flex">
            <button type="submit">Generate</button>
            <button type="button" class="secondary" onclick="copyOutput()">Copy output</button>
            <span id="aiStatus" class="muted"></span>
          </div>
          <div class="small muted" id="aiModeInfo" style="margin-top:6px"></div>
        </form>
        <pre id="gen_output" style="display:none"></pre>
      </section>
    </div>

    <section class="panel" style="margin-top:18px">
      <div class="list-header">
        <h3>3 Â· Recent automation runs</h3>
        <button type="button" class="secondary" onclick="refreshJobs()">Refresh</button>
      </div>
      <div id="jobsEmpty" class="muted" style="margin-top:12px;display:none">No generations yet. Launch one above.</div>
      <div id="jobsList"></div>
    </section>

    <section class="panel" style="margin-top:18px">
      <div class="schedule-board-header">
        <h3>4 Â· Publishing schedule</h3>
        <div class="schedule-board-actions">
          <button type="button" class="secondary" onclick="refreshSchedules()">Refresh</button>
        </div>
      </div>
      <div class="small" style="margin-top:4px">Track upcoming drops grouped by platform and delivery status.</div>
      <div id="scheduleEmpty" class="muted" style="margin-top:12px;display:none">No scheduled deliveries yet.</div>
      <div id="scheduleBoard" class="schedule-grid"></div>
    </section>
  </div>
  <div id="scheduleBackdrop" class="modal-backdrop"></div>
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <h3 id="scheduleModalTitle">Schedule delivery</h3>
      <form id="scheduleForm">
        <input type="hidden" id="schedule_job_id">
        <input type="hidden" id="schedule_edit_id">
        <label for="schedule_platform">Platform</label>
        <input id="schedule_platform" placeholder="TikTok Â· Instagram" required>
        <label for="schedule_time">Run at</label>
        <input id="schedule_time" type="datetime-local" required>
        <div class="flex">
          <button type="submit">Save</button>
          <button type="button" class="secondary" onclick="closeScheduleModal()">Cancel</button>
        </div>
        <div class="small muted" id="schedule_form_note" style="margin-top:8px"></div>
      </form>
    </div>
  </div>
  <div id="editorBackdrop" class="modal-backdrop"></div>
  <div id="editorModal" class="modal">
    <div class="modal-content">
      <h3>Edit script and re-render</h3>
      <form id="videoEditorForm">
        <input type="hidden" id="editor_job_id">
        <label for="editor_title">Title</label>
        <input id="editor_title" placeholder="Title">
        <label for="editor_script">Script</label>
        <textarea id="editor_script" placeholder="Paste or edit the script"></textarea>
        <label for="editor_background">Background</label>
        <div class="flex">
          <select id="editor_background" style="flex:1 1 auto"><option value="">(none â€” static title)</option></select>
          <button type="button" class="secondary" id="btn_refresh_bgs">Refresh</button>
          <button type="button" class="secondary" id="btn_seed_bgs">Seed</button>
        </div>
        <div class="flex">
          <label class="inline" style="gap:6px"><input type="checkbox" id="editor_subtitles" checked> Burn subtitles</label>
          <label class="inline" style="gap:6px">Voice <select id="editor_voice"><option value="">(default)</option></select></label>
          <button type="button" class="secondary" id="btn_refresh_voices">Refresh voices</button>
          <span class="small muted" id="voices_count" style="min-width:100px"></span>
          <label class="inline" style="gap:6px">Rate <input id="editor_rate" type="number" min="120" max="220" step="5" value="160" style="width:90px"></label>
        </div>
        <div class="flex">
          <label class="inline" style="gap:6px">Preview text
            <input id="editor_preview_text" placeholder="This is a sample voice." value="This is a sample voice." style="width:220px">
          </label>
          <button type="button" id="btn_preview_voice">Preview voice</button>
        </div>
        <audio id="voice_preview_audio" controls style="width:100%;margin-top:8px;display:none"></audio>
        <div class="flex">
          <label class="inline" style="gap:6px">Target duration (sec)
            <input id="editor_duration" type="number" min="0" step="5" value="120" style="width:110px">
          </label>
          <label class="inline" style="gap:6px"><input type="checkbox" id="editor_music"> Background music</label>
          <label class="inline" style="gap:6px">Music volume
            <input id="editor_music_volume" type="number" min="0" max="1" step="0.05" value="0.15" style="width:90px">
          </label>
          <label class="inline" style="gap:6px"><input type="checkbox" id="editor_ducking" checked> Duck under voice</label>
          <label class="inline" style="gap:6px"><input type="checkbox" id="editor_draw_title" checked> Overlay title</label>
        </div>
        <div class="flex">
          <button type="submit">Render</button>
          <button type="button" class="secondary" onclick="closeEditorModal()">Cancel</button>
        </div>
        <div class="small muted" id="editor_note" style="margin-top:8px"></div>
      </form>
    </div>
  </div>
  <script>
    const esc = (value) => String(value ?? '').replace(/[&<>]/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
    let publishers = [];
    let profiles = [];
    let jobs = [];
    let schedules = [];
  let backgrounds = [];
  let voices = [];
  let publisherStates = {};
    const profileSelect = document.getElementById('gen_profile');
    profileSelect.innerHTML = '<option value="">(loading profiles...)</option>';
    const scheduleModal = document.getElementById('scheduleModal');
    const scheduleBackdrop = document.getElementById('scheduleBackdrop');
    const scheduleForm = document.getElementById('scheduleForm');
    const scheduleStatusLabels = {
      scheduled: 'Scheduled',
      posted: 'Posted',
      failed: 'Failed',
      canceled: 'Canceled',
    };

    function derivePrimaryPlatform(raw) {
      if (!raw) return '';
      const pieces = String(raw)
        .split(/[Â·,\\/|]/)
        .map((part) => part.trim())
        .filter(Boolean);
      return pieces[0] || '';
    }

    function formatDisplayTime(iso) {
      if (!iso) return '';
      let normalized = iso;
      if (normalized.length === 16) {
        normalized = `${normalized}:00`;
      }
      const dt = new Date(normalized);
      if (Number.isNaN(dt.getTime())) {
        return iso.replace('T', ' ');
      }
      return dt.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    function updateJobScheduleSummary(el, jobId) {
      const jobSchedules = schedules.filter((item) => Number(item.job_id) === Number(jobId));
      if (!jobSchedules.length) {
        el.textContent = 'No scheduled deliveries yet.';
        return;
      }
      const counts = {};
      jobSchedules.forEach((item) => {
        const status = item.status || 'scheduled';
        counts[status] = (counts[status] || 0) + 1;
      });
      const parts = Object.entries(counts).map(([status, count]) => `${scheduleStatusLabels[status] || status}: ${count}`);
      const upcoming = jobSchedules
        .filter((item) => item.status === 'scheduled')
        .sort((a, b) => (a.scheduled_for_iso || '').localeCompare(b.scheduled_for_iso || ''))[0];
      let msg = `Schedules â†’ ${parts.join(', ')}`;
      if (upcoming) {
        msg += ` Â· Next drop ${formatDisplayTime(upcoming.scheduled_for_iso)}`;
      }
      el.textContent = msg;
    }

    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || (res.status + ' ' + res.statusText));
      }
      return await res.json();
    }

    async function loadBackgrounds() {
      try {
        const data = await fetchJSON('/ai/video/backgrounds');
        backgrounds = data.backgrounds || [];
      } catch (e) {
        backgrounds = [];
      }
      const sel = document.getElementById('editor_background');
      if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = '<option value="">(none â€” static title)</option>' + backgrounds.map((b) => `<option value="${esc(b)}">${esc(b)}</option>`).join('');
      if (cur && backgrounds.includes(cur)) sel.value = cur;
    }

    async function seedBackgroundsInUi(noteEl) {
      try {
        await fetchJSON('/ai/video/backgrounds/seed', { method: 'POST' });
        await loadBackgrounds();
        if (noteEl) noteEl.textContent = 'Backgrounds seeded.';
      } catch (e) {
        if (noteEl) noteEl.textContent = 'Seed failed: ' + e.message;
      }
    }

    async function loadVoices(opts = {}) {
      try {
        const qs = opts.refresh ? '?refresh=true' : '';
        const data = await fetchJSON('/ai/voices' + qs);
        voices = data.voices || [];
      } catch (e) {
        voices = [];
      }
      const sel = document.getElementById('editor_voice');
      if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = '<option value="">(default)</option>' + voices.map((v) => `<option value="${esc(v.name || v.id || '')}">${esc(v.name || v.id || '')}</option>`).join('');
      if (cur) sel.value = cur;
      const note = document.getElementById('editor_note');
      const vc = document.getElementById('voices_count');
      if (vc) {
        vc.textContent = voices.length ? `${voices.length} voices` : '0 voices';
      }
      if ((!voices || !voices.length) && note) {
        note.textContent = 'No local TTS voices detected. Install espeak-ng for offline voices, then click Refresh voices.';
      }
    }

    async function previewVoice() {
      const voice = document.getElementById('editor_voice').value.trim() || '';
      const rateRaw = document.getElementById('editor_rate').value;
      const rate = rateRaw ? Number(rateRaw) : undefined;
      const text = document.getElementById('editor_preview_text').value.trim() || 'This is a sample voice.';
      const note = document.getElementById('editor_note');
      const audio = document.getElementById('voice_preview_audio');
      if (note) note.textContent = 'Generating voice preview...';
      try {
        const res = await fetch('/ai/voices/preview', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text, voice, rate }),
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const url = data?.preview?.url;
        if (url && audio) {
          audio.src = url;
          audio.style.display = 'block';
          await audio.play().catch(() => {});
          if (note) note.textContent = 'Preview ready.';
        } else {
          if (note) note.textContent = 'Preview failed: no URL returned';
        }
      } catch (err) {
        if (note) note.textContent = 'Preview failed: ' + (err?.message || String(err));
      }
    }

    async function loadPublishers() {
      try {
        const data = await fetchJSON('/ai/publishers');
        publishers = data.publishers || [];
        renderPublishers();
      } catch (err) {
        console.error('Publishers load failed', err);
        const empty = document.getElementById('publishersEmpty');
        empty.style.display = 'block';
        empty.textContent = 'Failed to load publishers: ' + err.message;
      }
    }

    function renderPublishers() {
      const wrap = document.getElementById('publishersList');
      wrap.innerHTML = '';
      const empty = document.getElementById('publishersEmpty');
      if (!publishers.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      publishers.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'publisher-card';
        const status = publisherStates[p.slug] || null;
        const statusClass = status ? (status.ok ? 'ready' : 'error') : 'muted';
        const statusLabel = status ? status.message : 'No health check run yet';
        const required = (p.required_env || []).map((item) => `<span class="chip">${esc(item)}</span>`).join(' ');
        card.innerHTML = `
          <header>
            <div>
              <strong>${esc(p.display_name || p.slug)}</strong>
              <div class="small">${esc(p.description || '')}</div>
            </div>
            <button class="secondary" type="button" onclick="checkPublisher('${esc(p.slug)}')">Run health check</button>
          </header>
          <div class="small">Required env: ${required || 'â€”'}</div>
          ${p.notes ? `<div class="small" style="margin-top:8px">${esc(p.notes)}</div>` : ''}
          <div class="small status ${statusClass}" id="publisher-status-${esc(p.slug)}">${esc(statusLabel)}</div>
        `;
        wrap.appendChild(card);
      });
    }

    async function checkPublisher(slug) {
      const statusEl = document.getElementById(`publisher-status-${slug}`);
      if (statusEl) {
        statusEl.textContent = 'Checking...';
        statusEl.className = 'small status';
      }
      try {
        const data = await fetchJSON(`/ai/publishers/${slug}/health`, { method: 'POST' });
        const result = data.result || {};
        publisherStates[slug] = {
          ok: Boolean(result.success),
          message: result.message || 'Check complete',
        };
      } catch (err) {
        publisherStates[slug] = {
          ok: false,
          message: err.message,
        };
      }
      renderPublishers();
    }

    async function loadProfiles() {
      try {
        const data = await fetchJSON('/ai/profiles');
        profiles = data.profiles || [];
        renderProfiles();
      } catch (err) {
        console.error('Profiles load failed', err);
        document.getElementById('profilesEmpty').style.display = 'block';
        document.getElementById('profilesEmpty').textContent = 'Failed to load profiles: ' + err.message;
      }
    }

    function renderProfiles() {
      const wrap = document.getElementById('profilesList');
      wrap.innerHTML = '';
      const empty = document.getElementById('profilesEmpty');
      if (!profiles.length) {
        empty.style.display = 'block';
        if (!document.getElementById('gen_profile').value) {
          document.getElementById('gen_profile').innerHTML = '<option value="">(no saved profiles)</option>';
        }
        return;
      }
      empty.style.display = 'none';
      const select = document.getElementById('gen_profile');
      const previous = select.value;
      select.innerHTML = '<option value="">Custom prompt (no saved profile)</option>' + profiles.map(p => `<option value="${p.id}">${esc(p.name)}</option>`).join('');
      if (previous && profiles.some(p => String(p.id) === previous)) {
        select.value = previous;
      } else if (profiles.length) {
        select.value = profiles[0].id;
      }
      profiles.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'profile-card';
        const pid = JSON.stringify(p.id);
        card.innerHTML = `
          <header>
            <div>
              <strong>${esc(p.name)}</strong><div class="small">Updated ${esc(p.updated_at || '')}</div>
            </div>
            <div class="actions">
              <button class="secondary" type="button" onclick="prefillProfile(${pid})">Load</button>
              <button class="secondary" type="button" onclick="removeProfile(${pid})">Delete</button>
            </div>
          </header>
          <div class="small">Tone: ${esc(p.tone || 'â€”')}</div>
          <div class="small">Voice: ${esc(p.voice || 'â€”')}</div>
          <div class="small">Platforms: ${esc(p.target_platform || 'â€”')}</div>
          <div class="small" style="margin-top:6px">Guidelines:<br>${esc(p.guidelines || 'â€”')}</div>
        `;
        wrap.appendChild(card);
      });
    }

    async function saveProfile(event) {
      event.preventDefault();
      const payload = {
        name: document.getElementById('profile_name').value.trim(),
        tone: document.getElementById('profile_tone').value.trim(),
        voice: document.getElementById('profile_voice').value.trim(),
        target_platform: document.getElementById('profile_platform').value.trim(),
        guidelines: document.getElementById('profile_rules').value.trim(),
      };
      if (!payload.name) {
        alert('Profile name is required');
        return;
      }
      try {
        await fetchJSON('/ai/profiles', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        document.getElementById('profileForm').reset();
        loadProfiles();
      } catch (err) {
        alert('Save failed: ' + err.message);
      }
    }

    function prefillProfile(id) {
      const target = Number(id);
      const p = profiles.find((x) => Number(x.id) === target);
      if (!p) return;
      document.getElementById('profile_name').value = p.name;
      document.getElementById('profile_tone').value = p.tone;
      document.getElementById('profile_voice').value = p.voice;
      document.getElementById('profile_platform').value = p.target_platform;
      document.getElementById('profile_rules').value = p.guidelines;
      document.getElementById('gen_profile').value = String(p.id);
    }

    async function removeProfile(id) {
      if (!confirm('Delete this profile?')) return;
      const target = Number(id);
      try {
        await fetchJSON(`/ai/profiles/${target}`, { method: 'DELETE' });
        if (Number(document.getElementById('gen_profile').value) === target) {
          document.getElementById('gen_profile').value = '';
        }
        loadProfiles();
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    }

    async function runGeneration(event) {
      event.preventDefault();
      const payload = {
        profile_id: document.getElementById('gen_profile').value || null,
        content_type: document.getElementById('gen_type').value,
        title: document.getElementById('gen_title').value.trim(),
        keywords: document.getElementById('gen_keywords').value.trim(),
        brief: document.getElementById('gen_brief').value.trim(),
        data_sources: document.getElementById('gen_sources').value.trim(),
        extra: document.getElementById('gen_extra').value.trim(),
      };
      if (!payload.title) {
        alert('Title is required');
        return;
      }
      setStatus('Generating...');
      try {
        const data = await fetchJSON('/ai/content', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const job = data.job;
        const out = document.getElementById('gen_output');
        out.style.display = 'block';
        out.textContent = job.generated_content || '[no content returned]';
        setStatus(data.note || `Status: ${job.status}`);
        refreshJobs();
      } catch (err) {
        setStatus('Error: ' + err.message);
        const out = document.getElementById('gen_output');
        out.style.display = 'block';
        out.textContent = 'Generation failed: ' + err.message;
      }
    }

    async function refreshJobs() {
      try {
        const data = await fetchJSON('/ai/jobs');
        jobs = data.jobs || [];
        renderJobs();
      } catch (err) {
        console.error('Jobs load failed', err);
        const empty = document.getElementById('jobsEmpty');
        empty.style.display = 'block';
        empty.textContent = 'Failed to load jobs: ' + err.message;
      }
    }

    async function refreshSchedules() {
      try {
        const data = await fetchJSON('/ai/schedule');
        schedules = data.schedules || [];
        renderScheduleBoard();
        renderJobs();
      } catch (err) {
        console.error('Schedules load failed', err);
        const empty = document.getElementById('scheduleEmpty');
        if (empty) {
          empty.style.display = 'block';
          empty.textContent = 'Failed to load schedules: ' + err.message;
        }
      }
    }

    function renderJobs() {
      const wrap = document.getElementById('jobsList');
      wrap.innerHTML = '';
      const empty = document.getElementById('jobsEmpty');
      if (!jobs.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      jobs.forEach((j) => {
        const div = document.createElement('div');
        div.className = 'job';
        const primaryPlatform = derivePrimaryPlatform(j.profile_platform);
        const buttonLabel = primaryPlatform ? `Schedule for ${primaryPlatform}` : 'Schedule post';
        div.innerHTML = `
          <div class="inline">
            <strong>${esc(j.title)}</strong>
            <span class="chip">${esc(j.content_type || 'custom')}</span>
          </div>
          <div class="small">Profile: ${esc(j.profile_name || 'custom prompt')}</div>
          <div class="small">Ran ${esc(j.updated_at || j.created_at || '')}</div>
          <div class="status ${esc(j.status)}">Status: ${esc(j.status)}</div>
          <div class="small" style="margin-top:8px">Keywords: ${esc(j.keywords || 'â€”')}</div>
          <div class="small job-schedule-summary" style="margin-top:8px"></div>
          <div class="actions" style="margin-top:10px">
            <button type="button" class="schedule-trigger">${esc(buttonLabel)}</button>
            <button type="button" class="secondary to-video-trigger">Make video</button>
          </div>
          <details style="margin-top:10px">
            <summary class="small">View output</summary>
            <pre>${esc(j.generated_content || '')}</pre>
          </details>
          <div class="small" style="margin-top:10px;display:none" data-video-status></div>
          <div style="margin-top:10px;display:none" data-video-preview>
            <video controls playsinline style="width:100%;border-radius:10px;border:1px solid #1f2a3a"></video>
            <div class="flex" style="margin-top:8px">
              <button type="button" class="secondary edit-video-trigger">Edit & re-render</button>
              <a class="secondary" target="_blank" data-video-link>Open file</a>
            </div>
          </div>
        `;
        wrap.appendChild(div);
        const summaryEl = div.querySelector('.job-schedule-summary');
        if (summaryEl) {
          updateJobScheduleSummary(summaryEl, j.id);
        }
        const trigger = div.querySelector('.schedule-trigger');
        if (trigger) {
          trigger.addEventListener('click', () => openScheduleModal(j.id, primaryPlatform));
        }
        const toVideo = div.querySelector('.to-video-trigger');
        const videoStatus = div.querySelector('[data-video-status]');
        const previewWrap = div.querySelector('[data-video-preview]');
        const videoEl = previewWrap ? previewWrap.querySelector('video') : null;
        const videoLink = previewWrap ? previewWrap.querySelector('[data-video-link]') : null;
        if (toVideo && videoStatus) {
          toVideo.addEventListener('click', async () => {
            toVideo.disabled = true;
            videoStatus.style.display = 'block';
            videoStatus.textContent = 'Rendering video...';
            try {
              const res = await fetch('/ai/video', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ job_id: j.id }),
              });
              if (!res.ok) throw new Error(await res.text());
              const data = await res.json();
              const url = data?.video?.url;
              if (url) {
                const abs = url; // same-origin path
                videoStatus.textContent = 'Done';
                if (previewWrap && videoEl && videoLink) {
                  previewWrap.style.display = 'block';
                  videoEl.src = abs;
                  videoLink.href = abs;
                  videoLink.textContent = abs;
                } else {
                  videoStatus.innerHTML = `Done: <a href="${esc(abs)}" target="_blank">${esc(abs)}</a>`;
                }
              } else {
                videoStatus.textContent = 'Done, but no URL returned';
              }
            } catch (err) {
              videoStatus.textContent = 'Video failed: ' + (err?.message || String(err));
            } finally {
              toVideo.disabled = false;
            }
          });
        }

        const editTrigger = div.querySelector('.edit-video-trigger');
        if (editTrigger) {
          editTrigger.addEventListener('click', () => openEditorModal(j));
        }
      });
    }

    const editorModal = document.getElementById('editorModal');
    const editorBackdrop = document.getElementById('editorBackdrop');
    const editorForm = document.getElementById('videoEditorForm');
    function openEditorModal(job) {
      if (!editorModal || !editorBackdrop || !editorForm) return;
      document.getElementById('editor_job_id').value = String(job.id);
      document.getElementById('editor_title').value = job.title || '';
      document.getElementById('editor_script').value = job.generated_content || '';
  loadBackgrounds();
  loadVoices();
      document.getElementById('editor_note').textContent = '';
      editorBackdrop.classList.add('active');
      editorModal.classList.add('active');
      // Wire action buttons
      const btnBgs = document.getElementById('btn_refresh_bgs');
      if (btnBgs) btnBgs.onclick = () => loadBackgrounds();
      const btnSeed = document.getElementById('btn_seed_bgs');
      if (btnSeed) btnSeed.onclick = () => seedBackgroundsInUi(document.getElementById('editor_note'));
      const btnVoices = document.getElementById('btn_refresh_voices');
  if (btnVoices) btnVoices.onclick = () => loadVoices({ refresh: true });
      const btnPrev = document.getElementById('btn_preview_voice');
      if (btnPrev) btnPrev.onclick = () => previewVoice();
    }
    function closeEditorModal() {
      if (!editorModal || !editorBackdrop || !editorForm) return;
      editorBackdrop.classList.remove('active');
      editorModal.classList.remove('active');
      editorForm.reset();
      document.getElementById('editor_note').textContent = '';
    }
    if (editorBackdrop) editorBackdrop.addEventListener('click', closeEditorModal);
    if (editorModal) editorModal.addEventListener('click', (e) => { if (e.target === editorModal) closeEditorModal(); });
    if (editorForm) {
      editorForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const jobId = Number(document.getElementById('editor_job_id').value);
        const title = document.getElementById('editor_title').value.trim();
        const script = document.getElementById('editor_script').value.trim();
  const background = document.getElementById('editor_background').value.trim();
  const subtitles = document.getElementById('editor_subtitles').checked;
  const tts_voice = document.getElementById('editor_voice').value.trim();
  const tts_rate = Number(document.getElementById('editor_rate').value) || undefined;
  const min_duration = Number(document.getElementById('editor_duration').value) || undefined;
  const music = document.getElementById('editor_music').checked;
  const music_volume_raw = document.getElementById('editor_music_volume').value;
  const music_volume = music_volume_raw === '' ? undefined : Number(music_volume_raw);
  const ducking = document.getElementById('editor_ducking').checked;
  const draw_title = document.getElementById('editor_draw_title').checked;
        const note = document.getElementById('editor_note');
        if (!title || !script) {
          note.textContent = 'Title and script are required';
          return;
        }
        note.textContent = 'Rendering...';
        try {
          const res = await fetch('/ai/video', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              job_id: jobId || undefined,
              title,
              script,
              background,
              subtitles,
              tts_voice,
              tts_rate,
              min_duration,
              music,
              music_volume,
              ducking,
              draw_title,
            }),
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          const url = data?.video?.url;
          if (url) {
            note.innerHTML = `Done: <a href="${esc(url)}" target="_blank">${esc(url)}</a>`;
          } else {
            note.textContent = 'Done, but no URL returned';
          }
        } catch (err) {
          note.textContent = 'Video failed: ' + (err?.message || String(err));
        }
      });
    }

    function renderScheduleBoard() {
      const board = document.getElementById('scheduleBoard');
      const empty = document.getElementById('scheduleEmpty');
      if (!board || !empty) return;
      board.innerHTML = '';
      if (!schedules.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      const groups = {};
      schedules.forEach((entry) => {
        const platform = entry.platform || 'Unassigned';
        if (!groups[platform]) {
          groups[platform] = [];
        }
        groups[platform].push(entry);
      });
      const statusOrder = ['scheduled', 'posted', 'failed', 'canceled'];
      Object.keys(groups)
        .sort((a, b) => a.localeCompare(b))
        .forEach((platform) => {
          const entries = groups[platform];
          const container = document.createElement('div');
          container.className = 'schedule-platform';
          const header = document.createElement('header');
          const left = document.createElement('div');
          const title = document.createElement('strong');
          title.textContent = platform;
          const meta = document.createElement('div');
          meta.className = 'small';
          meta.textContent = `${entries.length} total drops`;
          left.appendChild(title);
          left.appendChild(meta);
          header.appendChild(left);
          const right = document.createElement('div');
          right.className = 'small';
          const upcoming = entries
            .filter((entry) => entry.status === 'scheduled')
            .sort((a, b) => (a.scheduled_for_iso || '').localeCompare(b.scheduled_for_iso || ''))[0];
          right.textContent = upcoming ? `Next: ${formatDisplayTime(upcoming.scheduled_for_iso)}` : 'No upcoming runs';
          header.appendChild(right);
          container.appendChild(header);
          const statusWrap = document.createElement('div');
          statusWrap.className = 'schedule-statuses';
          statusOrder.forEach((status) => {
            const subset = entries.filter((entry) => entry.status === status);
            if (!subset.length) return;
            const group = document.createElement('div');
            group.className = 'schedule-status-group';
            const groupTitle = document.createElement('div');
            groupTitle.className = 'schedule-status-title';
            groupTitle.textContent = `${scheduleStatusLabels[status] || status} Â· ${subset.length}`;
            group.appendChild(groupTitle);
            subset
              .slice()
              .sort((a, b) => (a.scheduled_for_iso || '').localeCompare(b.scheduled_for_iso || ''))
              .forEach((entry) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'schedule-entry';
                const titleRow = document.createElement('div');
                titleRow.className = 'inline';
                const name = document.createElement('strong');
                name.textContent = entry.job_title || `Job ${entry.job_id}`;
                const badge = document.createElement('span');
                badge.className = `status badge ${entry.status}`;
                badge.textContent = scheduleStatusLabels[entry.status] || entry.status;
                titleRow.appendChild(name);
                titleRow.appendChild(badge);
                entryDiv.appendChild(titleRow);
                const timeLine = document.createElement('div');
                timeLine.className = 'small';
                timeLine.textContent = `Runs ${formatDisplayTime(entry.scheduled_for_iso)}`;
                entryDiv.appendChild(timeLine);
                const jobLineParts = [];
                if (entry.job_profile_name) jobLineParts.push(entry.job_profile_name);
                if (entry.job_content_type) jobLineParts.push(entry.job_content_type);
                if (jobLineParts.length) {
                  const jobLine = document.createElement('div');
                  jobLine.className = 'small';
                  jobLine.textContent = jobLineParts.join(' â€¢ ');
                  entryDiv.appendChild(jobLine);
                }
                if (entry.result && entry.status === 'failed') {
                  const resultLine = document.createElement('div');
                  resultLine.className = 'small';
                  resultLine.textContent = entry.result;
                  entryDiv.appendChild(resultLine);
                }
                const actions = document.createElement('div');
                actions.className = 'actions';
                if (['scheduled', 'failed', 'canceled'].includes(entry.status)) {
                  const reschedBtn = document.createElement('button');
                  reschedBtn.type = 'button';
                  reschedBtn.className = 'secondary';
                  reschedBtn.textContent = 'Reschedule';
                  reschedBtn.addEventListener('click', () => openScheduleModalForExisting(entry.id));
                  actions.appendChild(reschedBtn);
                }
                if (entry.status === 'scheduled') {
                  const cancelBtn = document.createElement('button');
                  cancelBtn.type = 'button';
                  cancelBtn.className = 'secondary';
                  cancelBtn.textContent = 'Cancel';
                  cancelBtn.addEventListener('click', () => cancelSchedule(entry.id));
                  actions.appendChild(cancelBtn);
                }
                if (entry.status === 'failed') {
                  const retryBtn = document.createElement('button');
                  retryBtn.type = 'button';
                  retryBtn.textContent = 'Retry';
                  retryBtn.addEventListener('click', () => retrySchedule(entry.id));
                  actions.appendChild(retryBtn);
                  const cancelBtn = document.createElement('button');
                  cancelBtn.type = 'button';
                  cancelBtn.className = 'secondary';
                  cancelBtn.textContent = 'Cancel';
                  cancelBtn.addEventListener('click', () => cancelSchedule(entry.id));
                  actions.appendChild(cancelBtn);
                }
                if (entry.status === 'canceled') {
                  const reactivateBtn = document.createElement('button');
                  reactivateBtn.type = 'button';
                  reactivateBtn.textContent = 'Reactivate';
                  reactivateBtn.addEventListener('click', () => retrySchedule(entry.id));
                  actions.appendChild(reactivateBtn);
                }
                if (actions.children.length) {
                  entryDiv.appendChild(actions);
                }
                group.appendChild(entryDiv);
              });
            statusWrap.appendChild(group);
          });
          container.appendChild(statusWrap);
          board.appendChild(container);
        });
    }

    function setStatus(msg) {
      document.getElementById('aiStatus').textContent = msg || '';
    }

    function openScheduleModal(jobId, defaultPlatform = '', scheduleId = null, scheduledIso = '') {
      if (!scheduleModal || !scheduleBackdrop) return;
      const jobField = document.getElementById('schedule_job_id');
      const editField = document.getElementById('schedule_edit_id');
      const platformField = document.getElementById('schedule_platform');
      const timeField = document.getElementById('schedule_time');
      const note = document.getElementById('schedule_form_note');
      const title = document.getElementById('scheduleModalTitle');
      jobField.value = jobId ? String(jobId) : '';
      editField.value = scheduleId ? String(scheduleId) : '';
      platformField.value = typeof defaultPlatform === 'string' ? defaultPlatform : '';
      timeField.value = scheduledIso ? (scheduledIso.length > 16 ? scheduledIso.slice(0, 16) : scheduledIso) : '';
      note.textContent = scheduleId ? 'Update the drop time or platform, then save.' : 'Choose when and where to publish this job.';
      title.textContent = scheduleId ? 'Update schedule' : 'Schedule delivery';
      scheduleBackdrop.classList.add('active');
      scheduleModal.classList.add('active');
      setTimeout(() => platformField.focus(), 50);
    }

    function openScheduleModalForExisting(scheduleId) {
      const entry = schedules.find((item) => Number(item.id) === Number(scheduleId));
      if (!entry) return;
      openScheduleModal(entry.job_id, entry.platform, entry.id, entry.scheduled_for_iso);
    }

    function closeScheduleModal() {
      if (!scheduleModal || !scheduleBackdrop) return;
      scheduleModal.classList.remove('active');
      scheduleBackdrop.classList.remove('active');
      if (scheduleForm) {
        scheduleForm.reset();
      }
      document.getElementById('schedule_form_note').textContent = '';
      document.getElementById('schedule_edit_id').value = '';
    }

    async function submitScheduleForm(event) {
      event.preventDefault();
      const jobField = document.getElementById('schedule_job_id');
      const editField = document.getElementById('schedule_edit_id');
      const platformField = document.getElementById('schedule_platform');
      const timeField = document.getElementById('schedule_time');
      const note = document.getElementById('schedule_form_note');
      const platform = platformField.value.trim();
      const when = timeField.value;
      const scheduleId = editField.value;
      if (!platform || !when) {
        note.textContent = 'Platform and time are required.';
        return;
      }
      note.textContent = 'Saving...';
      try {
        if (scheduleId) {
          await fetchJSON(`/ai/schedule/${scheduleId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ platform, scheduled_for: when }),
          });
        } else {
          const jobId = Number(jobField.value);
          if (!jobId) {
            note.textContent = 'Missing job reference.';
            return;
          }
          await fetchJSON('/ai/schedule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ job_id: jobId, platform, scheduled_for: when }),
          });
        }
        closeScheduleModal();
        refreshSchedules();
      } catch (err) {
        console.error('Schedule save failed', err);
        note.textContent = 'Error: ' + err.message;
      }
    }

    async function cancelSchedule(scheduleId) {
      if (!confirm('Cancel this scheduled delivery?')) return;
      try {
        await fetchJSON(`/ai/schedule/${scheduleId}/cancel`, { method: 'POST' });
        refreshSchedules();
      } catch (err) {
        alert('Cancel failed: ' + err.message);
      }
    }

    async function retrySchedule(scheduleId) {
      try {
        await fetchJSON(`/ai/schedule/${scheduleId}/retry`, { method: 'POST' });
        refreshSchedules();
      } catch (err) {
        alert('Retry failed: ' + err.message);
      }
    }

    function copyOutput() {
      const text = document.getElementById('gen_output').textContent;
      if (!text) {
        alert('Nothing to copy yet.');
        return;
      }
      navigator.clipboard.writeText(text).then(() => setStatus('Copied to clipboard'), (err) => setStatus('Copy failed: ' + err));
    }

    if (scheduleBackdrop) {
      scheduleBackdrop.addEventListener('click', closeScheduleModal);
    }
    if (scheduleModal) {
      scheduleModal.addEventListener('click', (event) => {
        if (event.target === scheduleModal) {
          closeScheduleModal();
        }
      });
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeScheduleModal();
      }
    });

    document.getElementById('profileForm').addEventListener('submit', saveProfile);
    document.getElementById('generationForm').addEventListener('submit', runGeneration);
    if (scheduleForm) {
      scheduleForm.addEventListener('submit', submitScheduleForm);
    }

    // Show AI mode and reachability from the backend
    fetch('/ai/config')
      .then(r => r.ok ? r.json() : {})
      .then(cfg => {
        const info = document.getElementById('aiModeInfo');
        if (!info || !cfg) return;
        const local = cfg.local ? 'local' : 'remote';
        const reach = cfg.reachable ? 'reachable' : 'not reachable';
        info.textContent = `AI mode: ${local} Â· model: ${cfg.model || '?'} Â· base: ${cfg.api_base || '?'} Â· ${reach}`;
      })
      .catch(() => {
        const info = document.getElementById('aiModeInfo');
        if (info) info.textContent = 'AI mode: (failed to load config)';
      });

    loadPublishers();
    loadProfiles();
    refreshJobs();
    refreshSchedules();
  </script>
</body>
</html>
